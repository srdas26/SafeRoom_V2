CREATE DATABASE IF NOT EXISTS saferoom;
USE saferoom;

SET SQL_SAFE_UPDATES = 0;
SET FOREIGN_KEY_CHECKS = 0;

CREATE TABLE IF NOT EXISTS logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    timestamp DATETIME,
    level VARCHAR(10),
    classname VARCHAR(50),
    message TEXT
);

CREATE TABLE IF NOT EXISTS users (
    username VARCHAR(50) PRIMARY KEY,
    password_hash VARCHAR(256) NOT NULL,
    salt VARCHAR(64) NOT NULL,          
    email VARCHAR(100) NOT NULL,
    is_verified BOOLEAN DEFAULT FALSE,
    verification_code VARCHAR(10) DEFAULT  ('empty'),
    last_login TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


CREATE TABLE IF NOT EXISTS login_attempts (
    username VARCHAR(50) PRIMARY KEY,
    attempt_count INT DEFAULT 0,
    last_attempt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    attempt_time TIMESTAMP,
    FOREIGN KEY (username) REFERENCES users(username)
);

CREATE TABLE IF NOT EXISTS blocked_users (
    username VARCHAR(50) PRIMARY KEY,
    blocked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    reason VARCHAR(255) DEFAULT 'Too many failed attempts',
    ip_address VARCHAR(45) DEFAULT NULL,
    is_blocked BOOLEAN,
    FOREIGN KEY (username) REFERENCES users(username)
);

alter table users drop column age;

CREATE TABLE IF NOT EXISTS verification_attempts (
    username VARCHAR(50) PRIMARY KEY,
    attempts INT DEFAULT 0,
    last_attempt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (username) REFERENCES users(username)
);
CREATE TABLE IF NOT EXISTS STUN_INFO(
	username VARCHAR(50) PRIMARY KEY,
    FOREIGN KEY (username) REFERENCES users(username),
    Public_IP VARCHAR(20),
    Public_Port INTEGER
);

SELECT * FROM STUN_INFO;
ALTER TABLE STUN_INFO 
ADD COLUMN State  bool;

-- ===============================
-- PROFILE SYSTEM TABLES
-- ===============================

-- User statistics table
CREATE TABLE IF NOT EXISTS user_stats (
    username VARCHAR(50) PRIMARY KEY,
    rooms_created INT DEFAULT 0,
    rooms_joined INT DEFAULT 0,
    files_shared INT DEFAULT 0,
    messages_sent INT DEFAULT 0,
    security_score DECIMAL(3,1) DEFAULT 0.0,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE
);

-- User activities table
CREATE TABLE IF NOT EXISTS user_activities (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    activity_type VARCHAR(50) NOT NULL,
    description TEXT NOT NULL,
    activity_data TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE,
    INDEX idx_username_created (username, created_at)
);

-- Friend requests table
CREATE TABLE IF NOT EXISTS friend_requests (
    id INT AUTO_INCREMENT PRIMARY KEY,
    sender VARCHAR(50) NOT NULL,
    receiver VARCHAR(50) NOT NULL,
    message TEXT,
    status ENUM('pending', 'accepted', 'rejected') DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (sender) REFERENCES users(username) ON DELETE CASCADE,
    FOREIGN KEY (receiver) REFERENCES users(username) ON DELETE CASCADE,
    UNIQUE KEY unique_request (sender, receiver)
);

-- Friendships table (for accepted friend requests)
CREATE TABLE IF NOT EXISTS friendships (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user1 VARCHAR(50) NOT NULL,
    user2 VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user1) REFERENCES users(username) ON DELETE CASCADE,
    FOREIGN KEY (user2) REFERENCES users(username) ON DELETE CASCADE,
    UNIQUE KEY unique_friendship (user1, user2),
    INDEX idx_user1 (user1),
    INDEX idx_user2 (user2)
);

-- Blocked users table  
CREATE TABLE IF NOT EXISTS user_blocks (
    id INT AUTO_INCREMENT PRIMARY KEY,
    blocker VARCHAR(50) NOT NULL,
    blocked VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (blocker) REFERENCES users(username) ON DELETE CASCADE,
    FOREIGN KEY (blocked) REFERENCES users(username) ON DELETE CASCADE,
    UNIQUE KEY unique_block (blocker, blocked)
);

-- Insert sample data for existing users
INSERT IGNORE INTO user_stats (username, rooms_created, rooms_joined, files_shared, messages_sent, security_score) 
VALUES 
('abkarada', 5, 12, 8, 156, 8.5),
('James', 3, 7, 4, 89, 7.2);

-- Insert sample activities
INSERT IGNORE INTO user_activities (username, activity_type, description, activity_data) 
VALUES 
('James', 'login', 'User logged in', '{"ip": "192.168.1.100"}'),
('James', 'room_created', 'Created secure room "Development Team"', '{"room_name": "Development Team"}'),
('James', 'file_shared', 'Shared document project_specs.pdf', '{"file_name": "project_specs.pdf", "size": "2.1MB"}'),
('abkarada', 'login', 'User logged in', '{"ip": "192.168.1.101"}'),
('abkarada', 'room_joined', 'Joined room "Development Team"', '{"room_name": "Development Team"}'),
('abkarada', 'message_sent', 'Sent message in Development Team', '{"room": "Development Team", "message_length": 45}');

-- ===============================
-- HEARTBEAT & SESSION MANAGEMENT
-- ===============================

-- User sessions table for heartbeat tracking
CREATE TABLE IF NOT EXISTS user_sessions (
    username VARCHAR(50) NOT NULL,
    session_id VARCHAR(255) NOT NULL,
    last_heartbeat TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (username, session_id),
    FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE,
    INDEX idx_last_heartbeat (last_heartbeat)
);

